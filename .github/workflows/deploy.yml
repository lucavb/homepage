name: Deploy to GitHub Pages

on:
    push:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: read
    pages: write
    id-token: write

concurrency:
    group: 'pages'
    cancel-in-progress: false

jobs:
    deploy:
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version-file: '.nvmrc'
                  cache: 'npm'

            - name: Setup Pages
              id: pages
              uses: actions/configure-pages@v5

            - name: Install dependencies
              run: npm ci

            - name: Restore Astro build cache
              uses: actions/cache@v5
              with:
                  path: .astro/cache
                  key: ${{ runner.os }}-astro-${{ hashFiles('src/assets/images/**', 'src/content/**/*.mdx', 'package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-astro-

            - name: Build site
              env:
                  UV_THREADPOOL_SIZE: 4
                  MALLOC_ARENA_MAX: 2
              run: npm run build

            - name: Cache statistics
              run: |
                  echo "Cache size: $(du -sh .astro/cache | cut -f1)"
                  echo "Cache files: $(find .astro/cache -type f | wc -l)"

            - name: Upload artifact
              uses: actions/upload-pages-artifact@v4
              with:
                  path: ./dist

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

            - name: Notify deployment success
              if: success()
              run: |
                  curl -u "${{ secrets.NTFY_USERNAME }}:${{ secrets.NTFY_PASSWORD }}" \
                    -X POST "${{ secrets.NTFY_BASE_URL }}/${{ secrets.NTFY_TOPIC }}" \
                    -H "Title: ðŸš€ Deployment Successful" \
                    -H "Priority: default" \
                    -H "Tags: rocket,tada" \
                    -d "Site deployed successfully to ${{ steps.deployment.outputs.page_url }}. Commit: ${{ github.sha }}"

            - name: Notify deployment failure
              if: failure()
              run: |
                  curl -u "${{ secrets.NTFY_USERNAME }}:${{ secrets.NTFY_PASSWORD }}" \
                    -X POST "${{ secrets.NTFY_BASE_URL }}/${{ secrets.NTFY_TOPIC }}" \
                    -H "Title: ðŸ’¥ Deployment Failed" \
                    -H "Priority: urgent" \
                    -H "Tags: boom,warning" \
                    -d "Deployment failed for commit ${{ github.sha }}. Check the logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
