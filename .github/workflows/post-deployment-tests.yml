name: Post-Deployment Tests

on:
    workflow_run:
        workflows: ['Deploy to GitHub Pages']
        types:
            - completed
        branches:
            - main

jobs:
    test:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version-file: '.nvmrc'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Get Playwright version
              id: playwright-version
              run: echo "version=$(npm list @playwright/test --json | jq -r '.dependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT

            - name: Cache Playwright browsers
              uses: actions/cache@v5
              id: playwright-cache
              with:
                  path: ~/.cache/ms-playwright
                  key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

            - name: Install Playwright system dependencies
              run: npx playwright install-deps

            - name: Install Playwright Browsers
              if: steps.playwright-cache.outputs.cache-hit != 'true'
              run: npx playwright install

            - name: Run Playwright tests against production
              id: playwright
              continue-on-error: true
              env:
                  BASE_URL: https://luca-becker.me
              run: npx playwright test

            - name: Upload Playwright report on failure
              if: steps.playwright.outcome == 'failure'
              uses: actions/upload-artifact@v6
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 30

            - name: Run Lighthouse CI
              id: lighthouse
              continue-on-error: true
              run: npx @lhci/cli@0.14.x autorun

            - name: Upload Lighthouse report
              if: always()
              uses: actions/upload-artifact@v6
              with:
                  name: lighthouse-report
                  path: .lighthouseci/
                  retention-days: 30

            - name: Notify test success
              if: steps.playwright.outcome == 'success' && steps.lighthouse.outcome == 'success'
              run: |
                  curl -u "${{ secrets.NTFY_USERNAME }}:${{ secrets.NTFY_PASSWORD }}" \
                    -X POST "${{ secrets.NTFY_BASE_URL }}/${{ secrets.NTFY_TOPIC }}" \
                    -H "Title: ✅ Post-Deployment Tests Passed" \
                    -H "Priority: default" \
                    -H "Tags: white_check_mark,test_tube" \
                    -d "All smoke tests and Lighthouse CI passed on production site. Deployment is healthy."

            - name: Notify Playwright failure
              if: steps.playwright.outcome == 'failure'
              run: |
                  curl -u "${{ secrets.NTFY_USERNAME }}:${{ secrets.NTFY_PASSWORD }}" \
                    -X POST "${{ secrets.NTFY_BASE_URL }}/${{ secrets.NTFY_TOPIC }}" \
                    -H "Title: ⚠️ Playwright Tests Failed" \
                    -H "Priority: high" \
                    -H "Tags: warning,test_tube" \
                    -d "Playwright tests failed on production. Check the report: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            - name: Notify Lighthouse failure
              if: steps.lighthouse.outcome == 'failure'
              run: |
                  curl -u "${{ secrets.NTFY_USERNAME }}:${{ secrets.NTFY_PASSWORD }}" \
                    -X POST "${{ secrets.NTFY_BASE_URL }}/${{ secrets.NTFY_TOPIC }}" \
                    -H "Title: ⚠️ Lighthouse CI Failed" \
                    -H "Priority: high" \
                    -H "Tags: warning,lighthouse" \
                    -d "Lighthouse performance budgets not met. Check the report: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            - name: Fail job if tests failed
              if: steps.playwright.outcome == 'failure' || steps.lighthouse.outcome == 'failure'
              run: exit 1
