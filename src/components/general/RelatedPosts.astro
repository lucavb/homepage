---
import { getCollection } from 'astro:content';
import BlogCard from './BlogCard.astro';
import type { IBlogPost } from '@types';

interface Props {
    currentPostId: string;
    relatedPostIds?: string[];
    tags?: string[];
}

const { currentPostId, relatedPostIds, tags } = Astro.props;

const allPosts = await getCollection('blog', ({ data }) => {
    return data.draft !== true;
});

const getTagScore = (postTags: string[] | undefined, currentTags: string[] | undefined): number => {
    if (!postTags || !currentTags || postTags.length === 0 || currentTags.length === 0) {
        return 0;
    }
    const overlap = postTags.filter((tag) => currentTags.includes(tag)).length;
    return overlap;
};

let relatedPosts: IBlogPost[] = [];

if (relatedPostIds && relatedPostIds.length > 0) {
    relatedPosts = allPosts
        .filter((post) => relatedPostIds.includes(post.slug))
        .map((post) => ({
            id: post.slug,
            title: post.data.title,
            description: post.data.description,
            publishDate: post.data.publishDate,
            tags: post.data.tags,
            draft: post.data.draft,
            thumbnail: post.data.thumbnail,
            heroImagePath: post.data.heroImagePath,
        }));
}

if (relatedPosts.length < 3 && tags && tags.length > 0) {
    const tagBasedPosts = allPosts
        .filter((post) => post.slug !== currentPostId)
        .filter((post) => !relatedPostIds?.includes(post.slug))
        .map((post) => ({
            post,
            score: getTagScore(post.data.tags, tags),
        }))
        .filter(({ score }) => score > 0)
        .sort((a, b) => {
            if (b.score !== a.score) {
                return b.score - a.score;
            }
            return b.post.data.publishDate.getTime() - a.post.data.publishDate.getTime();
        })
        .slice(0, 3 - relatedPosts.length)
        .map(({ post }) => ({
            id: post.slug,
            title: post.data.title,
            description: post.data.description,
            publishDate: post.data.publishDate,
            tags: post.data.tags,
            draft: post.data.draft,
            thumbnail: post.data.thumbnail,
            heroImagePath: post.data.heroImagePath,
        }));

    relatedPosts = [...relatedPosts, ...tagBasedPosts];
}

if (relatedPosts.length < 3) {
    const recentPosts = allPosts
        .filter((post) => post.slug !== currentPostId)
        .filter((post) => !relatedPosts.some((rp) => rp.id === post.slug))
        .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime())
        .slice(0, 3 - relatedPosts.length)
        .map((post) => ({
            id: post.slug,
            title: post.data.title,
            description: post.data.description,
            publishDate: post.data.publishDate,
            tags: post.data.tags,
            draft: post.data.draft,
            thumbnail: post.data.thumbnail,
            heroImagePath: post.data.heroImagePath,
        }));

    relatedPosts = [...relatedPosts, ...recentPosts];
}

relatedPosts.sort((a, b) => b.publishDate.getTime() - a.publishDate.getTime());

const shouldShowRelatedPosts = relatedPosts.length > 0;
---

{
    shouldShowRelatedPosts && (
        <section class="mt-24 pt-12 pb-8 bg-gray-50 dark:bg-gray-800/50 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 rounded-2xl">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">Continue Reading</h2>
                <div class="w-32 h-1 bg-gradient-to-r from-blue-600 to-indigo-600 mx-auto mb-4" />
                <p class="text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
                    Explore more articles on similar topics
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {relatedPosts.map((post) => (
                    <BlogCard blogPost={post} />
                ))}
            </div>
        </section>
    )
}
