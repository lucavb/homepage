---
import { info } from '@data';
import '../styles/style.css';

export interface Props {
    title?: string;
    description?: string;
    ogImageUrl?: string;
    class?: string;
    publishDate?: Date;
    tags?: string[];
    isArticle?: boolean;
    author?: string;
    robots?: string;
}

const {
    title = '',
    description = '',
    ogImageUrl = '/assets/images/og-image.jpg',
    class: _className = 'light',
    publishDate,
    tags = [],
    isArticle = false,
    author = info.name,
    robots = 'index, follow',
} = Astro.props;

const siteUrl = info.baseUrl;
const currentUrl = new URL(Astro.url.pathname, siteUrl).toString();
const absoluteImageUrl = ogImageUrl.startsWith('http') ? ogImageUrl : new URL(ogImageUrl, siteUrl).toString();

const pageTitle = title ? `${title} | ${info.name}` : info.name;
const structuredData = {
    '@context': 'https://schema.org',
    '@type': isArticle ? 'Article' : 'WebPage',
    name: pageTitle,
    description: description,
    url: currentUrl,
    image: absoluteImageUrl,
    author: {
        '@type': 'Person',
        name: author,
        url: siteUrl,
        jobTitle: info.jobDescription,
        sameAs: [info.socialMedia.github, info.socialMedia.linkedin],
    },
    publisher: {
        '@type': 'Person',
        name: info.name,
        url: siteUrl,
    },
    ...(isArticle && publishDate
        ? {
              datePublished: publishDate.toISOString(),
              dateModified: publishDate.toISOString(),
              headline: title,
              keywords: tags.join(', '),
          }
        : {}),
};
---

<!doctype html>
<html lang="en" class="scroll-smooth">
    <head>
        <script is:inline>
            (function () {
                var t = localStorage.getItem('theme') || 'system';
                var d = t === 'dark' || (t === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                if (d) {
                    document.documentElement.classList.add('dark');
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            })();
        </script>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="theme-color" content="#FFFFFF" />
        <meta name="generator" content={Astro.generator} />

        <link
            rel="preload"
            href="/assets/fonts/optimized/Inter-Regular.woff2"
            as="font"
            type="font/woff2"
            crossorigin
        />
        <link
            rel="preload"
            href="/assets/fonts/optimized/Inter-SemiBold.woff2"
            as="font"
            type="font/woff2"
            crossorigin
        />
        <link
            rel="preload"
            href="/assets/fonts/optimized/Outfit-SemiBold.woff2"
            as="font"
            type="font/woff2"
            crossorigin
        />
        <link rel="preload" href="/assets/fonts/optimized/Outfit-Bold.woff2" as="font" type="font/woff2" crossorigin />

        <title>{pageTitle}</title>
        <meta name="description" content={description} />
        <meta name="author" content={author} />
        <meta name="robots" content={robots} />
        <link rel="canonical" href={currentUrl} />

        <meta property="og:type" content={isArticle ? 'article' : 'website'} />
        <meta property="og:title" content={pageTitle} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={absoluteImageUrl} />
        <meta property="og:image:alt" content={title || `${info.name} - ${info.jobDescription}`} />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
        <meta property="og:url" content={currentUrl} />
        <meta property="og:site_name" content={info.name} />
        <meta property="og:locale" content="en_US" />

        {
            isArticle && publishDate && (
                <>
                    <meta property="article:author" content={author} />
                    <meta property="article:published_time" content={publishDate.toISOString()} />
                    <meta property="article:modified_time" content={publishDate.toISOString()} />
                    {tags.map((tag) => (
                        <meta property="article:tag" content={tag} />
                    ))}
                </>
            )
        }

        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:site" content="@lucabecker" />
        <meta name="twitter:creator" content="@lucabecker" />
        <meta name="twitter:title" content={pageTitle} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={absoluteImageUrl} />
        <meta name="twitter:image:alt" content={title || `${info.name} - ${info.jobDescription}`} />

        <script type="application/ld+json" set:html={JSON.stringify(structuredData)} is:inline />

        <link rel="alternate" type="application/rss+xml" title="Luca Becker - Blog" href="/rss.xml" />

        <!-- Matomo Analytics - GDPR Compliant, Cookieless -->
        <script is:inline>
            var _paq = (window._paq = window._paq || []);

            // Set tracker URL and site ID first
            _paq.push(['setTrackerUrl', 'https://t.sunbury.xyz/matomo.php']);
            _paq.push(['setSiteId', 1]);

            // GDPR/Privacy configurations - NO COOKIES
            _paq.push(['disableCookies']);
            _paq.push(['setDoNotTrack', true]);

            // Basic tracking
            _paq.push(['trackPageView']);
            _paq.push(['enableLinkTracking']);

            // Enhanced outbound link tracking
            document.addEventListener('click', function (e) {
                var link = e.target.closest('a');
                if (!link || !link.href) return;

                var url = new URL(link.href, window.location.href);
                var isExternal = url.hostname !== window.location.hostname;
                var isDownload = /\.(pdf|zip|exe|dmg|doc|docx|xls|xlsx|ppt|pptx)$/i.test(url.pathname);

                if (isExternal && !isDownload) {
                    var linkText = link.innerText || link.getAttribute('aria-label') || url.hostname;
                    _paq.push(['trackEvent', 'Outbound Link', url.hostname, linkText.substring(0, 100)]);
                } else if (isDownload) {
                    var filename = url.pathname.split('/').pop();
                    _paq.push(['trackEvent', 'Download', filename]);
                }
            });

            // Load tracker script
            (function () {
                var d = document,
                    g = d.createElement('script'),
                    s = d.getElementsByTagName('script')[0];
                g.type = 'text/javascript';
                g.async = true;
                g.src = 'https://t.sunbury.xyz/matomo.js';

                // Enable heartbeat timer after script loads
                // Calling it from _paq queue doesn't work due to initialization timing,
                // so we explicitly call it after the tracker is ready
                g.onload = function () {
                    if (window.Matomo && window.Matomo.getAsyncTracker) {
                        var tracker = window.Matomo.getAsyncTracker();
                        if (tracker && tracker.enableHeartBeatTimer) {
                            tracker.enableHeartBeatTimer(15);
                        }
                    }
                };

                s.parentNode.insertBefore(g, s);
            })();
        </script>

        <!-- End Matomo Code -->

        <!-- Critical CSS - inline the most important styles -->
        <style>
            /* Critical styles for above-the-fold content */
            body {
                font-family:
                    'Inter',
                    -apple-system,
                    BlinkMacSystemFont,
                    'Segoe UI',
                    Roboto,
                    sans-serif;
                margin: 0;
                padding: 0;
            }
        </style>
        <noscript>
            <style>
                [data-animate] {
                    opacity: 1 !important;
                    transform: none !important;
                }
            </style>
        </noscript>
    </head>

    <body class:list={['bg-slate-50 dark:bg-slate-950', isArticle ? 'blog-page' : '']}>
        <a
            href="#main-content"
            class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-[100] focus:px-4 focus:py-2 focus:bg-violet-600 focus:text-white focus:rounded-lg focus:shadow-lg"
            >Skip to content</a
        >
        <slot />

        <script>
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px',
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('[data-animate]').forEach((el) => {
                observer.observe(el);
            });
        </script>
    </body>
</html>
