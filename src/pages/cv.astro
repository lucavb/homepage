---
import { info } from '@data';
import '../styles/style.css';
import GitHubIcon from '@components/icons/GitHubIcon.astro';
import LinkedInIcon from '@components/icons/LinkedInIcon.astro';
import MatrixIcon from '@components/icons/MatrixIcon.astro';

// Aggregate and categorize skills from all experiences
const allSkills = info.experience.flatMap((exp) => exp.skills || []);
const uniqueSkills = [...new Set(allSkills)];

const skillCategories = {
    Frontend: ['TypeScript', 'Angular', 'React', 'Cypress'],
    Backend: ['Java', 'Spring Boot', 'NestJS', 'Kotlin', 'PostgreSQL', 'OpenSearch', 'Redis'],
    'Cloud & DevOps': ['AWS', 'Kubernetes', 'GitHub Actions', 'Renovate'],
    Leadership: ['Team Leadership', 'Scrum', 'Technical Interviews', 'Due Diligence', 'Consulting'],
};

// Filter to only include skills that exist in uniqueSkills
const filteredCategories = Object.entries(skillCategories).reduce(
    (acc, [category, skills]) => {
        const matchedSkills = skills.filter((skill) => uniqueSkills.includes(skill));
        if (matchedSkills.length > 0) {
            acc[category] = matchedSkills;
        }
        return acc;
    },
    {} as Record<string, string[]>,
);
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>CV - {info.name}</title>
        <meta name="description" content={info.cvSummary} />
        <meta name="robots" content="noindex, nofollow" />
        <link
            rel="preload"
            href="/assets/fonts/optimized/Inter-Regular.woff2"
            as="font"
            type="font/woff2"
            crossorigin
        />
        <link
            rel="preload"
            href="/assets/fonts/optimized/Inter-SemiBold.woff2"
            as="font"
            type="font/woff2"
            crossorigin
        />
    </head>
    <body class="cv-page">
        <!-- Download Button (hidden on print) -->
        <div class="no-print download-bar">
            <div class="download-content">
                <button onclick="window.print()" class="download-btn">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download PDF
                </button>
                <span class="print-hint">Tip: Disable "Headers and footers" in print dialog</span>
            </div>
        </div>

        <!-- CV Content -->
        <article id="main-content" class="cv-container">
            <!-- Header (repeats on every page in print) -->
            <header class="cv-header print-header">
                <div class="header-content">
                    <h1>{info.name}</h1>
                    <p class="tagline">{info.jobDescription}</p>
                </div>
                <div class="contact-row">
                    <a href="mailto:hello@luca-becker.me" class="contact-item">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <rect width="20" height="16" x="2" y="4" rx="2"></rect>
                            <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
                        </svg>
                        <span>hello@luca-becker.me</span>
                    </a>
                    <a href={info.socialMedia.linkedin} class="contact-item" target="_blank">
                        <LinkedInIcon class="w-4 h-4" />
                        <span>LinkedIn</span>
                    </a>
                    <a href={info.socialMedia.github} class="contact-item" target="_blank">
                        <GitHubIcon class="w-4 h-4" />
                        <span>GitHub</span>
                    </a>
                    <a href={info.socialMedia.matrix} class="contact-item" target="_blank">
                        <MatrixIcon class="w-4 h-4" />
                        <span>Matrix</span>
                    </a>
                    <span class="contact-item location">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <span>Munich, Germany</span>
                    </span>
                </div>
            </header>

            <!-- Summary -->
            <section class="cv-section">
                <h2>About</h2>
                <p class="summary-text">{info.cvSummary}</p>
            </section>

            <!-- Experience -->
            <section class="cv-section">
                <h2>Experience</h2>
                <div class="entries">
                    {
                        info.experience.map((exp) => (
                            <article class="entry">
                                <div class="entry-header">
                                    <div class="entry-title">
                                        <h3>{exp.name}</h3>
                                        <span class="entry-location">{exp.location}</span>
                                    </div>
                                    <time class="entry-date">
                                        {exp.startDate} — {exp.endDate}
                                    </time>
                                </div>
                                <ul class="entry-details">
                                    {exp.description.map((desc) => {
                                        const cleanDesc = desc.replace(/^•\s*/, '');
                                        return cleanDesc.trim() && <li>{cleanDesc}</li>;
                                    })}
                                </ul>
                                {exp.skills && exp.skills.length > 0 && (
                                    <div class="entry-tags">
                                        {exp.skills.map((skill) => (
                                            <span class="tag">{skill}</span>
                                        ))}
                                    </div>
                                )}
                            </article>
                        ))
                    }
                </div>
            </section>

            <!-- Education -->
            <section class="cv-section education-section">
                <h2>Education</h2>
                <div class="entries">
                    {
                        info.education.map((edu) => (
                            <article class="entry">
                                <div class="entry-header">
                                    <div class="entry-title">
                                        <h3>{edu.name}</h3>
                                        <span class="entry-location">{edu.location}</span>
                                    </div>
                                    <time class="entry-date">
                                        {edu.startDate} — {edu.endDate}
                                    </time>
                                </div>
                                <ul class="entry-details">
                                    {edu.description.map((desc) => {
                                        const cleanDesc = desc.replace(/^•\s*/, '');
                                        return cleanDesc.trim() && <li>{cleanDesc}</li>;
                                    })}
                                </ul>
                            </article>
                        ))
                    }
                </div>
            </section>

            <!-- Skills & Languages -->
            <div class="two-column">
                <section class="cv-section skills-section">
                    <h2>Skills</h2>
                    <div class="skills-grid">
                        {
                            Object.entries(filteredCategories).map(([category, skills]) => (
                                <div class="skill-group">
                                    <h3>{category}</h3>
                                    <div class="skill-tags">
                                        {skills.map((skill) => (
                                            <span class="tag">{skill}</span>
                                        ))}
                                    </div>
                                </div>
                            ))
                        }
                    </div>
                </section>

                <section class="cv-section languages-section">
                    <h2>Languages</h2>
                    <div class="languages">
                        {
                            info.languages.map((lang) => (
                                <div class="language-item">
                                    <span class="language-name">{lang.name}</span>
                                    <span class="language-level">{lang.level}</span>
                                </div>
                            ))
                        }
                    </div>
                </section>
            </div>
        </article>
    </body>
</html>

<style is:global>
    .cv-page {
        font-family:
            'Inter',
            -apple-system,
            BlinkMacSystemFont,
            'Segoe UI',
            Roboto,
            sans-serif;
        font-size: 15px;
        line-height: 1.6;
        color: #111827;
        background: linear-gradient(135deg, #f1f5f9 0%, #ede9fe 50%, #e0f2fe 100%);
        min-height: 100vh;
        margin: 0;
        padding: 0;
    }

    .download-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%);
        padding: 12px 20px;
        z-index: 100;
    }

    .download-content {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        flex-wrap: wrap;
    }

    .download-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: white;
        color: #7c3aed;
        border: none;
        padding: 10px 24px;
        border-radius: 9999px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }

    .print-hint {
        color: rgba(255, 255, 255, 0.85);
        font-size: 13px;
    }

    .cv-container {
        max-width: 850px;
        margin: 80px auto 40px;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        padding: 48px;
        overflow: hidden;
    }

    /* Header */
    .cv-header {
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 1px solid #e5e7eb;
    }

    .header-content {
        margin-bottom: 16px;
    }

    .cv-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        color: #111827;
        margin: 0 0 4px 0;
        letter-spacing: -0.025em;
    }

    .tagline {
        font-size: 1.125rem;
        color: #6b7280;
        margin: 0;
        font-weight: 500;
    }

    .contact-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
    }

    .contact-item {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: #4b5563;
        text-decoration: none;
        font-size: 14px;
        transition: color 0.2s;
    }

    .contact-item:hover {
        color: #7c3aed;
    }

    .contact-item svg {
        color: #9ca3af;
        flex-shrink: 0;
    }

    .contact-item:hover svg {
        color: #7c3aed;
    }

    /* Sections */
    .cv-section {
        margin-bottom: 28px;
    }

    .cv-section:last-child {
        margin-bottom: 0;
    }

    .cv-section h2 {
        font-size: 0.75rem;
        font-weight: 700;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin: 0 0 16px 0;
    }

    .summary-text {
        color: #374151;
        margin: 0;
        font-size: 15px;
    }

    /* Entries */
    .entries {
        display: flex;
        flex-direction: column;
        gap: 28px;
    }

    .entry {
        position: relative;
        padding-left: 16px;
        border-left: 2px solid #c4b5fd;
    }

    .entry-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 8px;
    }

    .entry-title h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .entry-location {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .entry-date {
        font-size: 0.8125rem;
        color: #7c3aed;
        font-weight: 600;
        white-space: nowrap;
    }

    .entry-details {
        margin: 0;
        padding-left: 20px;
        color: #4b5563;
        font-size: 14px;
        list-style-type: disc;
    }

    .entry-details li {
        margin-bottom: 4px;
        padding-left: 4px;
    }

    .entry-details li::marker {
        color: #a78bfa;
    }

    .entry-details li:last-child {
        margin-bottom: 0;
    }

    .entry-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 12px;
    }

    .tag {
        display: inline-block;
        padding: 4px 12px;
        background: #ede9fe;
        color: #5b21b6;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 500;
    }

    /* Two Column Layout */
    .two-column {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 40px;
        margin-top: 8px;
    }

    .skills-grid {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .skill-group h3 {
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
        margin: 0 0 8px 0;
    }

    .skill-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .languages {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .language-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #f9fafb;
        border-radius: 8px;
    }

    .language-name {
        font-weight: 500;
        color: #111827;
    }

    .language-level {
        font-size: 13px;
        color: #6b7280;
        font-weight: 500;
    }

    /* Print Styles */
    @media print {
        @page {
            size: A4;
            margin: 10mm;
        }

        .no-print {
            display: none !important;
        }

        html,
        body {
            width: 210mm;
        }

        .cv-page {
            background: white;
            font-size: 9pt;
            line-height: 1.35;
        }

        .cv-container {
            margin: 0;
            padding: 0;
            box-shadow: none;
            border-radius: 0;
            max-width: none;
        }

        .cv-header {
            margin-bottom: 24px;
            padding-bottom: 14px;
        }

        .cv-header h1 {
            font-size: 18pt;
        }

        .tagline {
            font-size: 10pt;
        }

        .contact-row {
            gap: 12px;
            margin-bottom: 12px;
        }

        .contact-item {
            font-size: 8pt;
        }

        .contact-item svg {
            width: 12px;
            height: 12px;
        }

        .cv-section {
            margin-bottom: 10px;
        }

        .cv-section h2 {
            font-size: 8pt;
            margin-top: 10px;
            margin-bottom: 10px;
            break-after: avoid;
            page-break-after: avoid;
        }

        .cv-section:first-of-type h2 {
            margin-top: 0;
        }

        .summary-text {
            font-size: 9pt;
        }

        .entries {
            gap: 14px;
        }

        .entry {
            padding-left: 10px;
            break-inside: avoid;
            page-break-inside: avoid;
        }

        .entry-header {
            margin-bottom: 4px;
            break-after: avoid;
            page-break-after: avoid;
        }

        .entry-title h3 {
            font-size: 9pt;
        }

        .entry-location {
            font-size: 8pt;
        }

        .entry-date {
            font-size: 8pt;
        }

        .entry-details {
            font-size: 8pt;
            padding-left: 14px;
        }

        .entry-details li {
            margin-bottom: 1px;
        }

        .entry-tags {
            gap: 4px;
            margin-top: 6px;
        }

        .tag {
            padding: 2px 6px;
            font-size: 7pt;
            border-radius: 3px;
        }

        /* Table display for repeating header */
        .cv-container {
            display: table;
            width: 100%;
        }

        .print-header {
            display: table-header-group;
            width: 100%;
        }

        .cv-section {
            display: table-row-group;
            width: 100%;
        }

        .cv-section > * {
            display: block;
            width: 100%;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 20px;
            width: 100%;
        }

        .entries {
            display: block;
            width: 100%;
        }

        .entry {
            display: block;
            width: 100%;
            margin-bottom: 14px;
        }

        .entry:last-child {
            margin-bottom: 0;
        }

        .skill-group {
            margin-bottom: 10px;
        }

        .skill-group:last-child {
            margin-bottom: 0;
        }

        .skill-group h3 {
            font-size: 8pt;
            margin-bottom: 4px;
        }

        .skill-tags {
            gap: 3px;
        }

        .skills-grid {
            gap: 12px;
        }

        .language-item {
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 8pt;
        }

        .language-name,
        .language-level {
            font-size: 8pt;
        }

        /* Page break after education */
        .education-section {
            break-after: page;
            page-break-after: always;
        }

        /* Keep headers with content */
        h2,
        h3 {
            break-after: avoid;
            page-break-after: avoid;
        }

        /* Prevent orphans */
        p,
        li {
            orphans: 3;
            widows: 3;
        }

        /* Print colors */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        a {
            color: #7c3aed !important;
            text-decoration: none !important;
        }
    }

    /* Responsive */
    @media (max-width: 640px) {
        .cv-container {
            margin: 70px 16px 24px;
            padding: 24px;
        }

        .cv-header h1 {
            font-size: 1.75rem;
        }

        .two-column {
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .entry-header {
            flex-direction: column;
            gap: 4px;
        }
    }
</style>
